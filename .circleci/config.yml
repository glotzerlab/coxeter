# Python CircleCI 2.0 configuration file
#
# Check https://circleci.com/docs/2.0/language-python/ for more details
#
version: 2

jobs:
  style-check:
    docker:
      - image: circleci/python:3.10

    working_directory: ~/repo

    steps:
      - checkout
      - run: &style-check
          name: Style check
          command: |
            python -m pip install --progress-bar off --user -U pre-commit
            python -m pre_commit run --all-files


  test-3.10: &test-template
    docker:
      - image: cimg/python:3.10

    working_directory: ~/repo

    steps:

      - checkout

      - run: &install
          name: Install package
          command: |
            python -m pip install .[test] --progress-bar off --user

      - run: &run-tests
          name: Run tests
          command: |
            python --version
            python -c "import numpy; print('numpy', numpy.__version__)"
            python -c "import scipy; print('scipy', scipy.__version__)"
            python -m pytest

  test-3.9:
    <<: *test-template
    docker:
      - image: cimg/python:3.9

  test-3.8:
    <<: *test-template
    docker:
      - image: cimg/python:3.8

  pypi_wheels: &pypi_wheels
    docker:
      - image: cimg/python:3.10

    working_directory: ~/repo

    steps:
      - checkout

      - run:
          <<: *style-check

      - run:
          name: Create source distribution and wheels
          command: |
            python --version
            python -m pip --version
            python -m pip install --progress-bar off --user -U twine wheel setuptools
            python -m twine --version
            python -m wheel version
            python setup.py sdist
            python setup.py bdist_wheel

      - run:
          name: Install wheel
          command:
            python -m pip install coxeter[test] --progress-bar off --user -U --force-reinstall -f dist/

      - run:
          <<: *run-tests

      - run:
          name: Upload source distribution and wheels
          command: |
            python -m twine upload --username ${PYPI_USERNAME} --password ${PYPI_PASSWORD} dist/*

workflows:
  version: 2
  test:
    jobs:
      - test-3.10
      - test-3.9
      - test-3.8
  deploy:
    jobs:
      - pypi_wheels:
          filters:
            tags:
              only: /^v.*/
            branches:
              ignore: /.*/
