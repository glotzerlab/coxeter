# Python CircleCI 2.0 configuration file
#
# Check https://circleci.com/docs/2.0/language-python/ for more details
#
version: 2.1

orbs:
  codecov: codecov/codecov@3.2.2

jobs:
  test-310: &test-template
    docker:
      - image: cimg/python:3.10

    working_directory: ~/repo

    steps:

      - checkout

      - run: &install
          name: Install package
          command: |
            python -m pip install .[tests] --progress-bar off --user

      - run: &run-tests
          name: Run tests
          command: |
            python --version
            python -c "import numpy; print('numpy', numpy.__version__)"
            python -c "import scipy; print('scipy', scipy.__version__)"
            python -m pytest -v --cov=coxeter/ --cov-report=xml

  test-39:
    <<: *test-template
    docker:
      - image: cimg/python:3.9

  test-38:
    <<: *test-template
    docker:
      - image: cimg/python:3.8

  pypi_wheels: &pypi_wheels
    docker:
      - image: cimg/python:3.10

    working_directory: ~/repo

    steps:
      - checkout

      - run:
          name: Create source distribution and wheels
          command: |
            python --version
            python -m pip --version
            python -m pip install --progress-bar off --user -U twine wheel setuptools
            python -m twine --version
            python -m wheel version
            python setup.py sdist
            python setup.py bdist_wheel

      - run:
          name: Install wheel
          command:
            python -m pip install coxeter[tests] --progress-bar off --user -U --force-reinstall -f dist/

      - run:
          <<: *run-tests

      - run:
          name: Upload source distribution and wheels
          command: |
            python -m twine upload --username ${PYPI_USERNAME} --password ${PYPI_PASSWORD} dist/*

workflows:
  version: 2
  test:
    jobs:
      - test-310:
          post-steps:
            - codecov/upload
      - test-39
      - test-38
  deploy:
    jobs:
      - pypi_wheels:
          filters:
            tags:
              only: /^v.*/
            branches:
              ignore: /.*/
